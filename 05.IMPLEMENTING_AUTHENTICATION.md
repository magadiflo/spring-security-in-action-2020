# [Pág. 102] Capítulo 05 - Implementar la autenticación

## Entendiendo el AuthenticationProvider

La capa AuthenticationProvider, es la responsable de la lógica de autenticación. **El AuthenticationProvider** es
donde encuentra las condiciones e instrucciones que deciden si autenticar una solicitud o no.

Solo hay dos posibles resultados:

1. **La entidad que realiza la solicitud no está autenticada.** El usuario no es reconocido, y la aplicación rechaza la
   solicitud sin delegar al proceso de autorización. Por lo general, en este caso, el estado de respuesta que se
   devuelve al cliente es **HTTP 401 Unauthorized.**
2. **La entidad que realiza la solicitud está autenticada.** Los detalles sobre el solicitante se almacenan de manera
   que la aplicación pueda utilizarlos para la autorización. Como descubrirá en este capítulo, la interfaz
   SecurityContext es la instancia que almacena los detalles sobre la solicitud autenticada actualmente.

## Representación de la solicitud durante la autenticación

**El Authentication** es una de las interfaces esenciales involucradas en el proceso de autenticación. La interfaz de
autenticación representa el evento de solicitud de autenticación y contiene los detalles de la entidad que solicita
acceso a la aplicación. Puede utilizar la información relacionada con el evento de solicitud de autenticación durante y
después del proceso de autenticación. **El usuario que solicita acceso a la aplicación se denomina PRINCIPAL**. La
interfaz de autenticación de Spring Security amplía la interfaz Principal.

![Authentication-inherits-from-principal](./assets/Authentication-inherits-from-principal.png)

Por el momento, los únicos métodos de este contrato que necesitas aprender son estos:

- **isAuthenticated():** devuelve verdadero si el proceso de autenticación finaliza o falso si el proceso de
  autenticación aún está en curso.
- **getCredentials():** devuelve una contraseña o cualquier secreto utilizado en el proceso de autenticación (password,
  fingerprint, sms code, etc.)
- **getAuthorities():** devuelve una colección de autorizaciones otorgadas para la solicitud autenticada.

## Implementando una lógica de autenticación personalizada

**El AuthenticationProvider en Spring Security se encarga de la lógica de autenticación**. La implementación
predeterminada de la interfaz AuthenticationProvider delega la responsabilidad de encontrar el usuario del sistema a un
UserDetailsService. También utiliza PasswordEncoder para la gestión de contraseñas en el proceso de
autenticación.

El siguiente código proporciona **la definición de AuthenticationProvider**, que debe implementar para definir
un proveedor de autenticación personalizado para su aplicación.

````java
public interface AuthenticationProvider {
    Authentication authenticate(Authentication authentication) throws AuthenticationException;

    boolean supports(Class<?> authentication);
}
````

La responsabilidad de AuthenticationProvider está estrechamente relacionada con el contrato de autenticación. El método
authenticate() recibe un objeto de autenticación como parámetro y devuelve un objeto de autenticación. **Implementamos
el método authenticate() para definir la lógica de autenticación.** Podemos resumir rápidamente la forma en que debe
implementar el método de autenticación() con tres viñetas:

- El método debe lanzar una **AuthenticationException** si falla la autenticación.
- Si el método recibe un objeto de autenticación que no es compatible con su implementación de AuthenticationProvider,
  entonces el método debe devolver un valor nulo. De esta forma, tenemos la posibilidad de utilizar múltiples tipos de
  Autenticación separados a nivel de filtro HTTP.
- El método debe devolver una instancia de autenticación que represente un objeto completamente autenticado. Para esta
  instancia, el método isAuthenticated() devuelve verdadero y contiene todos los detalles necesarios sobre la entidad
  autenticada. Por lo general, la aplicación también elimina datos confidenciales como una contraseña de esta instancia.
  Después de la implementación, la contraseña ya no es necesaria y mantener estos detalles puede exponerlos
  potencialmente a ojos no deseados.

**El segundo método en la interfaz de AuthenticationProvider es supports(Class<?> authentication)**. Puede implementar
este método para devolver verdadero si el AuthenticationProvider actual admite el tipo proporcionado como un objeto de
autenticación. Observe que incluso si este método devuelve verdadero para un objeto, aún existe la posibilidad de que el
método authenticate() rechace la solicitud al devolver un valor nulo. Spring Security está diseñado así para ser
más flexible y permitirle implementar un AuthenticationProvider que puede rechazar una solicitud de autenticación en
función de los detalles de la solicitud, no solo por su tipo.

Una analogía de cómo el administrador de autenticación y el proveedor de autenticación trabajan juntos para validar o
invalidar una solicitud de autenticación es tener una cerradura más compleja para su puerta. Puede abrir esta cerradura
usando una tarjeta o una llave física antigua (figura 5.4). La propia cerradura es el gestor de autenticación que decide
si se abre la puerta. Para tomar esa decisión, delega en los dos proveedores de autenticación: uno que sabe validar la
tarjeta o el otro que sabe verificar la clave física. Si presentas una tarjeta para abrir la puerta, el proveedor de
autenticación que trabaja solo con llaves físicas se queja de que no conoce este tipo de autenticación.
Pero el otro proveedor admite este tipo de autenticación y verifica si la tarjeta es válida para la puerta. **Este es en
realidad el propósito de los métodos support().**

Además de probar el tipo de autenticación, Spring Security agrega una capa más de flexibilidad. La cerradura de la
puerta puede reconocer múltiples tipos de tarjetas. En este caso, cuando presente una tarjeta, uno de los proveedores de
autenticación podría decir: “Entiendo que esto es una tarjeta. ¡Pero no es el tipo de tarjeta que puedo validar!” **Esto
sucede cuando supports() devuelve verdadero pero authenticate() devuelve nulo.**
