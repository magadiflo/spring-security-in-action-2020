# [Pág. 433] Capítulo 18 - Manos a la obra: una aplicación OAuth 2

## [Pág. 434] El escenario de la aplicación

Digamos que necesitamos construir un backend para una aplicación de fitness. Además de otras excelentes funciones, la
aplicación también almacena un historial de los entrenamientos de los usuarios. En este capítulo, nos centraremos en la
parte de la aplicación que almacena el historial de entrenamientos. Suponemos que nuestro backend necesita implementar
tres casos de uso. Para cada acción definida por los casos de uso, tenemos restricciones de seguridad específicas (
figura 18.1). Los tres casos de uso son estos:

- Agregar un nuevo registro de entrenamiento para un usuario. En una tabla de base de datos llamada entrenamiento,
  agregamos un nuevo registro que almacena el usuario, los tiempos de inicio y fin del entrenamiento, y la dificultad
  del
  entrenamiento, usando un número entero en una escala de 1 a 5. La restricción de autorización para este uso case
  afirma
  que los usuarios autenticados solo pueden agregar registros de entrenamiento para ellos mismos. El cliente llama a un
  punto final expuesto por el servidor de recursos para agregar un nuevo registro de entrenamiento.

- Encuentra todos los entrenamientos para un usuario. El cliente necesita mostrar una lista de entrenamientos en el
  historial del usuario. El cliente llama a un punto final para recuperar esa lista. La restricción de autorización en
  este caso establece que un usuario solo puede obtener sus propios registros de entrenamiento.

- Eliminar un entrenamiento. Cualquier usuario que tenga el rol de administrador puede eliminar un entrenamiento para
  cualquier otro usuario. El cliente llama a un punto final para eliminar un registro de entrenamiento. La restricción
  de autorización dice que solo un administrador puede eliminar registros.

Necesitamos implementar tres casos de uso para los cuales tenemos dos roles de actuación. Los dos roles son el usuario
estándar, fitnessuser, y el administrador, fitnessadmin. Un usuario de fitness puede agregar un entrenamiento para sí
mismo y puede ver su propio historial de entrenamiento. Un administrador de fitness solo puede eliminar los registros de
entrenamiento de cualquier usuario. Por supuesto, un administrador también puede ser un usuario y, en este caso, también
puede agregar entrenamientos para sí mismo o ver sus propios entrenamientos grabados.

El backend que implementamos con estos tres casos de uso es un servidor de recursos OAuth 2 (figura 18.2). También
necesitamos un servidor de autorización. Para este ejemplo, usamos una herramienta llamada Keycloak para configurar el
servidor de autorización para el sistema. Keycloak ofrece todas las posibilidades para configurar nuestros usuarios ya
sea localmente o integrándose con otros servicios de administración de usuarios. Comenzamos las implementaciones
configurando una instancia local de Keycloak como nuestro servidor de autorización.

![figure-18-2](./assets/figure-18-2.png)

Luego implementamos el servidor de recursos y configuramos las reglas de autorización usando Spring Security. Una vez
que tenemos una aplicación en funcionamiento, la probamos llamando al punto final con cURL.

